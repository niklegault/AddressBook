<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Address Book</title>
</head>
<body>
    <form action="#" th:action="@{/}" method="get">
        <p>
            <input type="submit" value="Return Home" />
        </p>
    </form>
    <h1 th:text="'Buddies in Address Book #' + ${addressBook.getId()}">Address Book Buddies</h1>

    <form id="addBuddyForm"
          action="#"
          th:action="@{/addressBooks/{id}/buddies(id=${addressBook.getId()})}"
          th:object="${buddyInfo}"
          method="post">
        <p>
            Name <input type="text" th:field="*{name}"/>
        </p>
        <p>
            Phone number <input type="text" th:field="*{phone}"/>
        </p>
        <p>
            Address <input type="text" th:field="*{address}"/>
        </p>
        <p>
            <input type="submit" value="Create Buddy" />
        </p>
    </form>

    <table id="buddyTableBody">
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="buddy : ${addressBook.buddies}">
                <td th:text="${buddy.name}">John Doe</td>
                <td th:text="${buddy.phone}">111</td>
                <td th:text="${buddy.address}">123 main st</td>
            </tr>
        </tbody>
    </table>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
           const buddyForm = document.getElementById("addBuddyForm");
           buddyForm.addEventListener("submit", function(event) {
               event.preventDefault();
               const url = buddyForm.action;
               const formData = new FormData(buddyForm);

               fetch(url, {
                   method: 'POST',
                   body: new URLSearchParams(formData)
               }).then(response => {
                   if(response.ok) {
                       window.location.reload();
                   } else {
                       alert("Failed to create buddy")
                   }
               }).catch(error => {
                   console.error("Error: ", error);
                   alert("An Error occured");
               });
           });
        });

    </script>

</body>
</html>